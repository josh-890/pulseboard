generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum PersonStatus {
  active
  inactive
  wishlist
  archived
}

enum AliasType {
  common
  birth
  alias
}

enum ContributionRole {
  main
  supporting
  background
}

enum SetType {
  photo
  video
}

enum RelationshipSource {
  derived
  manual
}

enum ProjectStatus {
  active
  paused
  completed
}

enum ActivityType {
  person_added
  set_added
  project_added
  label_added
  note
}

enum EntityType {
  person
  set
}

enum BodyMarkType {
  tattoo
  scar
  mark
  burn
  deformity
  other
}

enum BodyMarkStatus {
  present
  modified
  removed
}

enum BodyMarkEventType {
  added
  modified
  removed
}

// ─── Person & Aliases ─────────────────────────────────────────────────────────

model Person {
  id             String  @id @default(cuid())
  icgId          String  @unique
  birthdate      DateTime?
  sexAtBirth     String?
  birthPlace     String?
  nationality    String?
  ethnicity      String?
  location       String?
  height         Int?
  naturalHairColor String?
  eyeColor       String?
  bodyType       String?
  measurements   String?
  activeSince    Int?
  specialization String?
  status         PersonStatus @default(active)
  rating         Int?
  pgrade         Int?
  notes          String?
  tags           String[]

  aliases          PersonAlias[]
  personas         Persona[]
  contributions    SetContribution[]
  relationships    PersonRelationship[] @relation("PersonA")
  relatedTo        PersonRelationship[] @relation("PersonB")
  bodyMarks        BodyMark[]
  digitalIdentities PersonDigitalIdentity[]
  skills           PersonSkill[]

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([status])
  @@index([deletedAt])
}

model PersonAlias {
  id        String    @id @default(cuid())
  personId  String
  person    Person    @relation(fields: [personId], references: [id])
  name      String
  type      AliasType @default(alias)
  deletedAt DateTime?

  @@index([personId])
  @@index([name])
  @@index([deletedAt])
}

model Persona {
  id         String    @id @default(cuid())
  personId   String
  person     Person    @relation(fields: [personId], references: [id])
  label      String
  notes      String?
  isBaseline Boolean   @default(false)
  date       DateTime?
  createdAt  DateTime  @default(now())
  deletedAt  DateTime?

  physicalChange    PersonaPhysical?
  bodyMarkEvents    BodyMarkEvent[]
  digitalIdentities PersonDigitalIdentity[]
  skills            PersonSkill[]

  @@index([personId])
  @@index([deletedAt])
}

model PersonaPhysical {
  id              String  @id @default(cuid())
  personaId       String  @unique
  persona         Persona @relation(fields: [personaId], references: [id])
  weight          Float?
  currentHairColor String?
  build           String?
  visionAids      String?
  fitnessLevel    String?
}

model BodyMark {
  id          String         @id @default(cuid())
  personId    String
  person      Person         @relation(fields: [personId], references: [id])
  type        BodyMarkType
  bodyRegion  String
  side        String?
  position    String?
  description String?
  motif       String?
  colors      String[]
  size        String?
  status      BodyMarkStatus @default(present)
  deletedAt   DateTime?
  createdAt   DateTime       @default(now())

  events BodyMarkEvent[]

  @@index([personId])
  @@index([status])
  @@index([deletedAt])
}

model BodyMarkEvent {
  id          String            @id @default(cuid())
  bodyMarkId  String
  bodyMark    BodyMark          @relation(fields: [bodyMarkId], references: [id])
  personaId   String
  persona     Persona           @relation(fields: [personaId], references: [id])
  eventType   BodyMarkEventType
  notes       String?
  deletedAt   DateTime?

  @@index([bodyMarkId])
  @@index([personaId])
  @@index([deletedAt])
}

model PersonDigitalIdentity {
  id        String    @id @default(cuid())
  personId  String
  person    Person    @relation(fields: [personId], references: [id])
  personaId String?
  persona   Persona?  @relation(fields: [personaId], references: [id])
  platform  String
  handle    String?
  url       String?
  status    String    @default("active")
  validFrom DateTime?
  validTo   DateTime?
  deletedAt DateTime?

  @@index([personId])
  @@index([personaId])
  @@index([deletedAt])
}

model PersonSkill {
  id        String    @id @default(cuid())
  personId  String
  person    Person    @relation(fields: [personId], references: [id])
  personaId String?
  persona   Persona?  @relation(fields: [personaId], references: [id])
  name      String
  category  String?
  level     String?
  evidence  String?
  validFrom DateTime?
  validTo   DateTime?
  deletedAt DateTime?

  @@index([personId])
  @@index([personaId])
  @@index([deletedAt])
}

model PersonRelationship {
  id            String             @id @default(cuid())
  personAId     String
  personA       Person             @relation("PersonA", fields: [personAId], references: [id])
  personBId     String
  personB       Person             @relation("PersonB", fields: [personBId], references: [id])
  source        RelationshipSource @default(derived)
  label         String?
  sharedSetCount Int               @default(0)
  deletedAt     DateTime?

  @@unique([personAId, personBId])
  @@index([personAId])
  @@index([personBId])
  @@index([deletedAt])
}

// ─── Organizations ────────────────────────────────────────────────────────────

model Network {
  id          String  @id @default(cuid())
  name        String
  description String?
  website     String?
  deletedAt   DateTime?

  labelMemberships LabelNetwork[]

  @@index([name])
  @@index([deletedAt])
}

model Label {
  id          String  @id @default(cuid())
  name        String
  description String?
  website     String?
  deletedAt   DateTime?

  networks  LabelNetwork[]
  channels  Channel[]
  projects  ProjectLabel[]

  @@index([name])
  @@index([deletedAt])
}

model LabelNetwork {
  labelId   String
  label     Label   @relation(fields: [labelId], references: [id])
  networkId String
  network   Network @relation(fields: [networkId], references: [id])

  @@id([labelId, networkId])
}

model Channel {
  id       String  @id @default(cuid())
  labelId  String
  label    Label   @relation(fields: [labelId], references: [id])
  name     String
  url      String?
  platform String?
  deletedAt DateTime?

  sets Set[]

  @@index([labelId])
  @@index([deletedAt])
}

// ─── Production ───────────────────────────────────────────────────────────────

model Project {
  id          String        @id @default(cuid())
  name        String
  description String?
  status      ProjectStatus @default(active)
  tags        String[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?

  labels   ProjectLabel[]
  sessions Session[]

  @@index([status])
  @@index([updatedAt])
  @@index([deletedAt])
}

model ProjectLabel {
  projectId String
  project   Project @relation(fields: [projectId], references: [id])
  labelId   String
  label     Label   @relation(fields: [labelId], references: [id])

  @@id([projectId, labelId])
}

model Session {
  id          String    @id @default(cuid())
  projectId   String
  project     Project   @relation(fields: [projectId], references: [id])
  name        String
  description String?
  date        DateTime?
  createdAt   DateTime  @default(now())
  deletedAt   DateTime?

  sets Set[]

  @@index([projectId])
  @@index([date])
  @@index([deletedAt])
}

model Set {
  id          String    @id @default(cuid())
  sessionId   String
  session     Session   @relation(fields: [sessionId], references: [id])
  channelId   String?
  channel     Channel?  @relation(fields: [channelId], references: [id])
  type        SetType
  title       String
  description String?
  notes       String?
  releaseDate DateTime?
  category    String?
  genre       String?
  tags        String[]
  createdAt   DateTime  @default(now())
  deletedAt   DateTime?

  contributions SetContribution[]

  @@index([sessionId])
  @@index([channelId])
  @@index([type])
  @@index([releaseDate])
  @@index([deletedAt])
}

model SetContribution {
  id       String           @id @default(cuid())
  setId    String
  set      Set              @relation(fields: [setId], references: [id])
  personId String
  person   Person           @relation(fields: [personId], references: [id])
  role     ContributionRole @default(main)
  deletedAt DateTime?

  @@unique([setId, personId])
  @@index([setId])
  @@index([personId])
  @@index([deletedAt])
}

// ─── Photos ───────────────────────────────────────────────────────────────────

model Photo {
  id         String     @id @default(cuid())
  entityType EntityType
  entityId   String     // polymorphic: points to Person.id or Set.id depending on entityType

  filename       String
  mimeType       String
  size           Int
  originalWidth  Int
  originalHeight Int
  variants       Json

  tags             String[]
  linkedEntityType String?
  linkedEntityId   String?

  caption    String?
  isFavorite Boolean   @default(false)
  sortOrder  Int       @default(0)

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([entityType, entityId])
  @@index([entityType, entityId, isFavorite])
  @@index([deletedAt])
  @@index([tags], type: Gin)
}

// ─── System ───────────────────────────────────────────────────────────────────

model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model Activity {
  id    String       @id @default(cuid())
  title String
  time  DateTime
  type  ActivityType

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([time])
  @@index([type])
  @@index([deletedAt])
}
