generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ─── Enums ────────────────────────────────────────────────────────────────────

enum PersonStatus {
  active
  inactive
  wishlist
  archived
}

enum AliasType {
  common
  birth
  alias
}

enum AliasSource {
  MANUAL
  IMPORT
}

enum SetType {
  photo
  video
}

enum RelationshipSource {
  derived
  manual
}

enum ProjectStatus {
  active
  paused
  completed
}

enum ActivityType {
  person_added
  set_added
  project_added
  label_added
  session_added
  note
}

enum EntityType {
  person
  set
  bodyModification
  cosmeticProcedure
}

enum BodyMarkType {
  tattoo
  scar
  mark
  burn
  deformity
  other
}

enum BodyMarkStatus {
  present
  modified
  removed
}

enum BodyMarkEventType {
  added
  modified
  removed
}

enum DatePrecision {
  UNKNOWN
  YEAR
  MONTH
  DAY
}

enum BodyModificationType {
  piercing
  stretching
  branding
  scarification
  implant
  teeth
  jewelry
  other
}

enum BodyModificationStatus {
  present
  removed
  overgrown
  modified
}

enum BodyModificationEventType {
  added
  modified
  removed
}

enum CosmeticProcedureEventType {
  performed
  revised
  reversed
}

enum EducationType {
  primary
  secondary
  undergraduate
  graduate
  postgraduate
  vocational
  continuing
  other
}

enum AwardType {
  degree
  certificate
  license
  award
  honor
  other
}

enum RelationshipType {
  professional
  personal
  familial
  other
}

enum RelationshipEventType {
  started
  married
  separated
  divorced
  ended
  other
}

enum SessionStatus {
  DRAFT
  CONFIRMED
  REFERENCE
}

enum MediaType {
  PHOTO
  VIDEO
}

enum ParticipantRole {
  MODEL
  PHOTOGRAPHER
}

enum ResolutionStatus {
  UNRESOLVED
  RESOLVED
  IGNORED
}

enum EvidenceType {
  CHANNEL_MAP
  MANUAL
}

enum PersonMediaUsage {
  PROFILE
  REFERENCE
  HEADSHOT
  BODY_MARK
  BODY_MODIFICATION
  COSMETIC_PROCEDURE
  PORTFOLIO
}

// ─── Person & Aliases ─────────────────────────────────────────────────────────

model Person {
  id             String  @id @default(cuid())
  icgId          String  @unique
  birthdate      DateTime?
  birthdatePrecision DatePrecision @default(UNKNOWN)
  sexAtBirth     String?
  birthPlace     String?
  nationality    String?
  ethnicity      String?
  location       String?
  height         Int?
  naturalHairColor String?
  eyeColor       String?
  bodyType       String?
  measurements   String?
  activeSince    Int?
  retiredIn      Int?
  birthMarks     String?
  specialization String?
  status         PersonStatus @default(active)
  rating         Int?
  pgrade         Int?
  notes          String?
  tags           String[]

  aliases          PersonAlias[]
  personas         Persona[]
  relationships    PersonRelationship[] @relation("PersonA")
  relatedTo        PersonRelationship[] @relation("PersonB")
  bodyMarks        BodyMark[]
  digitalIdentities PersonDigitalIdentity[]
  skills           PersonSkill[]
  bodyModifications    BodyModification[]
  cosmeticProcedures   CosmeticProcedure[]
  education            PersonEducation[]
  awards               PersonAward[]
  interests            PersonInterest[]
  sessionParticipants  SessionParticipant[]
  setParticipants      SetParticipant[]
  resolvedCredits      SetCreditRaw[]
  personMediaLinks     PersonMediaLink[]
  referenceSession     Session?             @relation("ReferenceSession")

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([status])
  @@index([deletedAt])
}

model PersonAlias {
  id        String      @id @default(cuid())
  personId  String
  person    Person      @relation(fields: [personId], references: [id])
  name      String
  type      AliasType   @default(alias)
  source    AliasSource @default(MANUAL)
  nameNorm  String?
  deletedAt DateTime?

  @@index([personId])
  @@index([name])
  @@index([nameNorm])
  @@index([deletedAt])
}

model Persona {
  id         String    @id @default(cuid())
  personId   String
  person     Person    @relation(fields: [personId], references: [id])
  label      String
  notes      String?
  isBaseline Boolean   @default(false)
  date       DateTime?
  datePrecision DatePrecision @default(UNKNOWN)
  createdAt  DateTime  @default(now())
  deletedAt  DateTime?

  physicalChange    PersonaPhysical?
  bodyMarkEvents    BodyMarkEvent[]
  digitalIdentities PersonDigitalIdentity[]
  skills            PersonSkill[]
  bodyModificationEvents    BodyModificationEvent[]
  cosmeticProcedureEvents   CosmeticProcedureEvent[]

  @@index([personId])
  @@index([deletedAt])
}

model PersonaPhysical {
  id              String  @id @default(cuid())
  personaId       String  @unique
  persona         Persona @relation(fields: [personaId], references: [id])
  weight          Float?
  currentHairColor String?
  build           String?
  visionAids      String?
  fitnessLevel    String?
}

model BodyMark {
  id          String         @id @default(cuid())
  personId    String
  person      Person         @relation(fields: [personId], references: [id])
  type        BodyMarkType
  bodyRegion  String
  side        String?
  position    String?
  description String?
  motif       String?
  colors      String[]
  size        String?
  status      BodyMarkStatus @default(present)
  deletedAt   DateTime?
  createdAt   DateTime       @default(now())

  events          BodyMarkEvent[]
  personMediaLinks PersonMediaLink[]

  @@index([personId])
  @@index([status])
  @@index([deletedAt])
}

model BodyMarkEvent {
  id          String            @id @default(cuid())
  bodyMarkId  String
  bodyMark    BodyMark          @relation(fields: [bodyMarkId], references: [id])
  personaId   String
  persona     Persona           @relation(fields: [personaId], references: [id])
  eventType   BodyMarkEventType
  notes       String?
  deletedAt   DateTime?

  @@index([bodyMarkId])
  @@index([personaId])
  @@index([deletedAt])
}

model PersonDigitalIdentity {
  id        String    @id @default(cuid())
  personId  String
  person    Person    @relation(fields: [personId], references: [id])
  personaId String?
  persona   Persona?  @relation(fields: [personaId], references: [id])
  platform  String
  handle    String?
  url       String?
  status    String    @default("active")
  validFrom DateTime?
  validFromPrecision DatePrecision @default(UNKNOWN)
  validTo   DateTime?
  validToPrecision   DatePrecision @default(UNKNOWN)
  deletedAt DateTime?

  @@index([personId])
  @@index([personaId])
  @@index([deletedAt])
}

model PersonSkill {
  id        String    @id @default(cuid())
  personId  String
  person    Person    @relation(fields: [personId], references: [id])
  personaId String?
  persona   Persona?  @relation(fields: [personaId], references: [id])
  name      String
  category  String?
  level     String?
  evidence  String?
  validFrom DateTime?
  validFromPrecision DatePrecision @default(UNKNOWN)
  validTo   DateTime?
  validToPrecision   DatePrecision @default(UNKNOWN)
  deletedAt DateTime?

  @@index([personId])
  @@index([personaId])
  @@index([deletedAt])
}

model PersonRelationship {
  id            String             @id @default(cuid())
  personAId     String
  personA       Person             @relation("PersonA", fields: [personAId], references: [id])
  personBId     String
  personB       Person             @relation("PersonB", fields: [personBId], references: [id])
  source        RelationshipSource @default(derived)
  type          RelationshipType?
  label         String?
  sharedSetCount Int               @default(0)
  validFrom     DateTime?
  validFromPrecision DatePrecision @default(UNKNOWN)
  validTo       DateTime?
  validToPrecision   DatePrecision @default(UNKNOWN)
  context       String?
  deletedAt     DateTime?

  events RelationshipEvent[]

  @@unique([personAId, personBId])
  @@index([personAId])
  @@index([personBId])
  @@index([deletedAt])
}

// ─── Body Modifications ──────────────────────────────────────────────────────

model BodyModification {
  id          String  @id @default(cuid())
  personId    String
  person      Person  @relation(fields: [personId], references: [id])
  type        BodyModificationType
  bodyRegion  String
  side        String?
  position    String?
  description String?
  material    String?
  gauge       String?
  status      BodyModificationStatus @default(present)
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())

  events          BodyModificationEvent[]
  personMediaLinks PersonMediaLink[]

  @@index([personId])
  @@index([type])
  @@index([status])
  @@index([deletedAt])
}

model BodyModificationEvent {
  id                 String  @id @default(cuid())
  bodyModificationId String
  bodyModification   BodyModification @relation(fields: [bodyModificationId], references: [id])
  personaId          String
  persona            Persona @relation(fields: [personaId], references: [id])
  eventType          BodyModificationEventType
  notes              String?
  deletedAt          DateTime?

  @@index([bodyModificationId])
  @@index([personaId])
  @@index([deletedAt])
}

// ─── Cosmetic Procedures ─────────────────────────────────────────────────────

model CosmeticProcedure {
  id          String  @id @default(cuid())
  personId    String
  person      Person  @relation(fields: [personId], references: [id])
  type        String
  bodyRegion  String
  description String?
  provider    String?
  status      String  @default("completed")
  deletedAt   DateTime?
  createdAt   DateTime  @default(now())

  events          CosmeticProcedureEvent[]
  personMediaLinks PersonMediaLink[]

  @@index([personId])
  @@index([deletedAt])
}

model CosmeticProcedureEvent {
  id                  String  @id @default(cuid())
  cosmeticProcedureId String
  cosmeticProcedure   CosmeticProcedure @relation(fields: [cosmeticProcedureId], references: [id])
  personaId           String
  persona             Persona @relation(fields: [personaId], references: [id])
  eventType           CosmeticProcedureEventType
  notes               String?
  deletedAt           DateTime?

  @@index([cosmeticProcedureId])
  @@index([personaId])
  @@index([deletedAt])
}

// ─── Education & Awards ──────────────────────────────────────────────────────

model PersonEducation {
  id            String  @id @default(cuid())
  personId      String
  person        Person  @relation(fields: [personId], references: [id])
  type          EducationType
  institution   String
  field         String?
  degree        String?
  startDate     DateTime?
  startDatePrecision DatePrecision @default(UNKNOWN)
  endDate       DateTime?
  endDatePrecision   DatePrecision @default(UNKNOWN)
  notes         String?
  deletedAt     DateTime?
  createdAt     DateTime @default(now())

  @@index([personId])
  @@index([deletedAt])
}

model PersonAward {
  id            String  @id @default(cuid())
  personId      String
  person        Person  @relation(fields: [personId], references: [id])
  type          AwardType
  name          String
  issuer        String?
  date          DateTime?
  datePrecision DatePrecision @default(UNKNOWN)
  context       String?
  url           String?
  deletedAt     DateTime?
  createdAt     DateTime @default(now())

  @@index([personId])
  @@index([deletedAt])
}

// ─── Interests ───────────────────────────────────────────────────────────────

model PersonInterest {
  id            String  @id @default(cuid())
  personId      String
  person        Person  @relation(fields: [personId], references: [id])
  name          String
  category      String?
  level         String?
  validFrom     DateTime?
  validFromPrecision DatePrecision @default(UNKNOWN)
  validTo       DateTime?
  validToPrecision   DatePrecision @default(UNKNOWN)
  notes         String?
  deletedAt     DateTime?
  createdAt     DateTime @default(now())

  @@index([personId])
  @@index([deletedAt])
}

// ─── Relationship Events ─────────────────────────────────────────────────────

model RelationshipEvent {
  id              String  @id @default(cuid())
  relationshipId  String
  relationship    PersonRelationship @relation(fields: [relationshipId], references: [id])
  eventType       RelationshipEventType
  date            DateTime?
  datePrecision   DatePrecision @default(UNKNOWN)
  notes           String?
  deletedAt       DateTime?
  createdAt       DateTime @default(now())

  @@index([relationshipId])
  @@index([deletedAt])
}

// ─── Organizations ────────────────────────────────────────────────────────────

model Network {
  id          String  @id @default(cuid())
  name        String
  nameNorm    String?
  description String?
  website     String?
  deletedAt   DateTime?

  labelMemberships LabelNetworkLink[]

  @@index([name])
  @@index([nameNorm])
  @@index([deletedAt])
}

model Label {
  id          String  @id @default(cuid())
  name        String
  nameNorm    String?
  description String?
  website     String?
  deletedAt   DateTime?

  networks        LabelNetworkLink[]
  projects        ProjectLabel[]
  primaryProjects Project[]          @relation("PrimaryLabel")
  sessions        Session[]
  channelMaps     ChannelLabelMap[]
  labelEvidence   SetLabelEvidence[]

  @@index([name])
  @@index([nameNorm])
  @@index([deletedAt])
}

model LabelNetworkLink {
  labelId   String
  label     Label   @relation(fields: [labelId], references: [id])
  networkId String
  network   Network @relation(fields: [networkId], references: [id])

  @@id([labelId, networkId])
  @@map("LabelNetwork")
}

model Channel {
  id        String  @id @default(cuid())
  name      String
  nameNorm  String?
  url       String?
  platform  String?
  notes     String?
  deletedAt DateTime?

  sets      Set[]
  labelMaps ChannelLabelMap[]

  @@index([nameNorm])
  @@index([deletedAt])
}

// ─── Evidence Layer ──────────────────────────────────────────────────────────

model ChannelLabelMap {
  channelId  String
  channel    Channel @relation(fields: [channelId], references: [id])
  labelId    String
  label      Label   @relation(fields: [labelId], references: [id])
  confidence Float   @default(1.0)
  notes      String?
  createdAt  DateTime @default(now())

  @@id([channelId, labelId])
}

model SetLabelEvidence {
  setId        String
  set          Set          @relation(fields: [setId], references: [id])
  labelId      String
  label        Label        @relation(fields: [labelId], references: [id])
  evidenceType EvidenceType
  confidence   Float        @default(1.0)
  notes        String?
  createdAt    DateTime     @default(now())

  @@id([setId, labelId, evidenceType])
}

// ─── Production ───────────────────────────────────────────────────────────────

model Project {
  id          String        @id @default(cuid())
  name        String
  nameNorm    String?
  description String?
  status      ProjectStatus @default(active)
  tags        String[]
  labelId     String?
  label       Label?        @relation("PrimaryLabel", fields: [labelId], references: [id])
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  deletedAt   DateTime?

  labels   ProjectLabel[]
  sessions Session[]

  @@index([status])
  @@index([updatedAt])
  @@index([nameNorm])
  @@index([deletedAt])
  @@index([labelId])
}

model ProjectLabel {
  projectId String
  project   Project @relation(fields: [projectId], references: [id])
  labelId   String
  label     Label   @relation(fields: [labelId], references: [id])

  @@id([projectId, labelId])
}

model Session {
  id          String        @id @default(cuid())
  projectId   String?
  project     Project?      @relation(fields: [projectId], references: [id])
  labelId     String?
  label       Label?        @relation(fields: [labelId], references: [id])
  personId    String?       @unique
  person      Person?       @relation("ReferenceSession", fields: [personId], references: [id])
  name        String
  nameNorm    String?
  description String?
  location    String?
  status      SessionStatus @default(DRAFT)
  notes       String?
  date        DateTime?
  datePrecision DatePrecision @default(UNKNOWN)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  mediaItems      MediaItem[]
  participants    SessionParticipant[]
  setSessionLinks SetSession[]

  @@index([projectId])
  @@index([labelId])
  @@index([personId])
  @@index([date])
  @@index([status])
  @@index([nameNorm])
  @@index([deletedAt])
}

model Set {
  id          String    @id @default(cuid())
  channelId   String?
  channel     Channel?  @relation(fields: [channelId], references: [id])
  type        SetType
  title       String
  titleNorm   String?
  description String?
  notes       String?
  releaseDate DateTime?
  releaseDatePrecision DatePrecision @default(UNKNOWN)
  isCompilation Boolean  @default(false)
  coverMediaItemId String?
  coverMediaItem   MediaItem? @relation("SetCoverMedia", fields: [coverMediaItemId], references: [id])
  category    String?
  genre       String?
  tags        String[]
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  deletedAt   DateTime?

  setMediaItems   SetMediaItem[]
  creditsRaw      SetCreditRaw[]
  participants    SetParticipant[]
  labelEvidence   SetLabelEvidence[]
  sessionLinks    SetSession[]

  @@index([channelId])
  @@index([type])
  @@index([releaseDate])
  @@index([titleNorm])
  @@index([deletedAt])
  @@index([coverMediaItemId])
}

// ─── Media ───────────────────────────────────────────────────────────────────

model MediaItem {
  id          String    @id @default(cuid())
  sessionId   String
  session     Session   @relation(fields: [sessionId], references: [id])
  mediaType   MediaType
  capturedAt  DateTime?
  capturedAtPrecision DatePrecision @default(UNKNOWN)

  filename       String
  fileRef        String?
  mimeType       String
  size           Int
  hash           String?
  originalWidth  Int
  originalHeight Int
  durationMs     Int?
  variants       Json?

  caption    String?
  tags       String[]
  notes      String?

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  deletedAt DateTime?

  setMediaItems    SetMediaItem[]
  personMediaLinks PersonMediaLink[]
  coverForSets     Set[]             @relation("SetCoverMedia")

  @@index([sessionId])
  @@index([hash])
  @@index([mediaType])
  @@index([deletedAt])
  @@index([tags], type: Gin)
}

model SetMediaItem {
  setId       String
  set         Set       @relation(fields: [setId], references: [id])
  mediaItemId String
  mediaItem   MediaItem @relation(fields: [mediaItemId], references: [id])
  sortOrder   Int       @default(0)
  isCover     Boolean   @default(false)
  caption     String?
  notes       String?

  @@id([setId, mediaItemId])
}

model SessionParticipant {
  sessionId         String
  session           Session         @relation(fields: [sessionId], references: [id])
  personId          String
  person            Person          @relation(fields: [personId], references: [id])
  role              ParticipantRole
  creditNameOverride String?
  createdAt         DateTime        @default(now())

  @@id([sessionId, personId, role])
}

model SetParticipant {
  setId    String
  set      Set             @relation(fields: [setId], references: [id])
  personId String
  person   Person          @relation(fields: [personId], references: [id])
  role     ParticipantRole

  @@id([setId, personId, role])
}

model SetSession {
  setId     String
  set       Set     @relation(fields: [setId], references: [id])
  sessionId String
  session   Session @relation(fields: [sessionId], references: [id])
  isPrimary Boolean @default(false)
  createdAt DateTime @default(now())

  @@id([setId, sessionId])
}

model SetCreditRaw {
  id               String           @id @default(cuid())
  setId            String
  set              Set              @relation(fields: [setId], references: [id])
  role             ParticipantRole
  rawName          String
  nameNorm         String?   @map("rawNameNorm")
  resolutionStatus ResolutionStatus @default(UNRESOLVED)
  resolvedPersonId String?
  resolvedPerson   Person?          @relation(fields: [resolvedPersonId], references: [id])
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  deletedAt        DateTime?

  @@index([setId])
  @@index([resolutionStatus])
  @@index([nameNorm])
  @@index([resolvedPersonId])
  @@index([deletedAt])
}

model PersonMediaLink {
  id          String           @id @default(cuid())
  personId    String
  person      Person           @relation(fields: [personId], references: [id])
  mediaItemId String
  mediaItem   MediaItem        @relation(fields: [mediaItemId], references: [id])
  usage       PersonMediaUsage
  isFavorite  Boolean          @default(false)
  sortOrder   Int              @default(0)
  notes       String?

  slot                 Int?
  bodyRegion           String?
  bodyMarkId           String?
  bodyMark             BodyMark?           @relation(fields: [bodyMarkId], references: [id])
  bodyModificationId   String?
  bodyModification     BodyModification?   @relation(fields: [bodyModificationId], references: [id])
  cosmeticProcedureId  String?
  cosmeticProcedure    CosmeticProcedure?  @relation(fields: [cosmeticProcedureId], references: [id])

  createdAt   DateTime         @default(now())
  deletedAt   DateTime?

  @@unique([personId, mediaItemId, usage])
  @@index([personId])
  @@index([mediaItemId])
  @@index([bodyMarkId])
  @@index([bodyModificationId])
  @@index([cosmeticProcedureId])
  @@index([deletedAt])
}

// ─── Photos (deprecated — replaced by MediaItem in Phase 2) ─────────────────

model Photo {
  id         String     @id @default(cuid())
  entityType EntityType
  entityId   String     // polymorphic: points to Person.id or Set.id depending on entityType

  filename       String
  mimeType       String
  size           Int
  originalWidth  Int
  originalHeight Int
  variants       Json

  tags             String[]
  linkedEntityType String?
  linkedEntityId   String?

  caption    String?
  isFavorite Boolean   @default(false)
  sortOrder  Int       @default(0)

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([entityType, entityId])
  @@index([entityType, entityId, isFavorite])
  @@index([deletedAt])
  @@index([tags], type: Gin)
}

// ─── System ───────────────────────────────────────────────────────────────────

model Setting {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}

model Activity {
  id    String       @id @default(cuid())
  title String
  time  DateTime
  type  ActivityType

  createdAt DateTime  @default(now())
  deletedAt DateTime?

  @@index([time])
  @@index([type])
  @@index([deletedAt])
}
